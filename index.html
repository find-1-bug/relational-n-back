
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Relational N-Back — Dynamic Relation Buttons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220;
      --panel:#171b2e;
      --muted:#7e86a3;
      --text:#eef2ff;
      --accent:#5ee1a2;
      --accent-2:#77b5ff;
      --warn:#ffb454;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
      color:var(--text);
      background: radial-gradient(1200px 700px at 10% -10%, #1b2140 0%, var(--bg) 45%), linear-gradient(180deg, #101428, #0b0e1b);
      display:flex; flex-direction:column; align-items:center;
    }
    header{
      width:100%; max-width:1100px; padding:18px 20px; display:flex; gap:16px; align-items:center; justify-content:space-between;
    }
    header h1{font-size:20px; margin:0; letter-spacing:0.3px}
    header .links{display:flex; gap:10px; align-items:center}
    .chip{
      font-size:12px; color:var(--muted); padding:6px 10px; border:1px solid #283054; border-radius:999px; text-decoration:none;
      display:inline-flex; align-items:center; gap:6px; background:#12162a99; backdrop-filter: blur(6px);
    }
    .container{
      width:100%; max-width:1100px; padding:0 20px 30px; display:grid; grid-template-columns: 340px 1fr; gap:20px;
    }
    @media (max-width: 960px){
      .container{grid-template-columns:1fr; padding:0 10px 80px;}
    }
    .card{
      background:linear-gradient(180deg, #151a33, #11162c);
      border:1px solid #262c4a;
      border-radius:14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 16px; font-size:14px; text-transform:uppercase; letter-spacing:1.2px; color:#b9c3ea;
      border-bottom:1px solid #262c4a; background:#121733;
    }
    .card .content{padding:14px 16px}
    .grid{display:grid; gap:8px;}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    label{font-size:12px; color:#b6bdd9; display:block; margin-bottom:6px;}
    input[type="number"], select, input[type="text"]{
      width:100%; padding:10px 12px; background:#0e1230; color:var(--text);
      border:1px solid #2c375f; border-radius:10px; outline:none; word-break:break-all;
    }
    input[type="range"]{width:100%}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .hint{font-size:12px; color:#b6bdd9}
    .switch{display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none; font-size:13px; color:#d7defa; min-width:160px;}
    .switch input{display:none}
    .toggle{
      width:44px; height:24px; background:#0e1230; border:1px solid #2c375f; border-radius:999px; position:relative; transition:.2s ease all; flex-shrink:0;
    }
    .toggle::after{
      content:""; width:18px; height:18px; background:#dfe7ff; border-radius:50%;
      position:absolute; top:2px; left:2px; transition:.2s ease all; box-shadow: 0 2px 6px rgba(0,0,0,0.35);
    }
    .switch input:checked + .toggle{background:linear-gradient(90deg, var(--accent-2), var(--accent)); border-color:transparent;}
    .switch input:checked + .toggle::after{left:24px; background:#0b1330}
    .stage{min-height:560px; display:grid; grid-template-rows: auto auto 1fr auto; gap:14px; padding:16px;}
    .statusbar{
      display:grid; grid-template-columns: 1fr auto auto auto auto; gap:8px; align-items:center;
      font-size:13px; color:#c9d2ff;
    }
    .statusbar .badge{
      padding:6px 10px; border:1px solid #2b3561; border-radius:10px; background:#0e1331; color:#cfe4ff;
    }
    .stimulus-area{
      display:grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap:12px; justify-content:center; align-content:center; padding:8px 0; max-width:min(90vw, 360px); margin:0 auto;
      aspect-ratio:1; padding-inline: clamp(8px, 3vw, 16px);
    }
    .cell{
      border-radius:12px; background:transparent; border:1px solid #ffffff; display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden; aspect-ratio:1/1;
    }
    .cell.active{
      outline:2px solid var(--accent);
      box-shadow: 0 0 0 6px rgba(94,225,162,0.12) inset, 0 0 30px rgba(94,225,162,0.25);
    }
    .relation-bar{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; padding:6px 0 2px;}
    .rel-btn{
      padding:10px 12px; border-radius:12px; background:#0f1334; border:1px solid #2b3561; color:#dbe5ff;
      font-weight:600; font-size:13px; letter-spacing:0.2px; cursor:pointer; transition:.15s ease all;
      display:inline-flex; align-items:center; gap:8px; user-select:none; position:relative;
    }
    .rel-btn .sub{
      position:absolute; top:-10px; left:50%; transform:translate(-50%,-100%);
      background:#0b102b; border:1px solid #2a3560; padding:3px 8px; border-radius:8px; font-size:11px; color:#9fb4ff; opacity:.9;
    }
    .rel-btn.kbd::before,
    .btn.kbd::before{
      content:attr(data-key);
      font-weight:700; font-size:11px; background:#0b102b; border:1px solid #2a3560; color:#9fb4ff; padding:3px 6px; border-radius:6px;
    }
    .rel-btn:hover{transform:translateY(-1px); border-color:#3a4782}
    .rel-btn:active{transform:translateY(0)}
    .rel-btn.matching{
      background:linear-gradient(180deg, rgba(94,225,162,0.15), rgba(94,225,162,0.06));
      border-color:#3a6c58; color:#dff9ee;
    }
    .rel-btn.pending{animation: pulse 1.1s ease-in-out infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 rgba(94,225,162,0)} 50%{box-shadow: 0 0 0 8px rgba(94,225,162,0.08)}}
    .controls{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:8px 0 4px;}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid #2b3561; background:#0e1331; color:#dbe5ff; cursor:pointer; font-weight:700;}
    .btn.primary{background:linear-gradient(180deg, #2a5cff, #1b3cc9); border-color:#2a5cff; box-shadow: 0 8px 20px rgba(42,92,255,0.25);}
    .btn.ghost{background:#0e1331}
    .btn.warn{background:linear-gradient(180deg, #ff9a5c, #f0722e); border-color:#ff9a5c}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .log{
      height:100px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#0b102a; border:1px dashed #2b3561; border-radius:10px; padding:10px; color:#b6c3ff; font-size:12px; overflow-y:auto;
    }
    .legend{font-size:12px; color:#9fb4ff; text-align:center}
    .bar{height:8px; background:#0b102a; border:1px solid #2b3561; border-radius:999px; overflow:hidden;}
    .bar > .fill{height:100%; width:0%; background:linear-gradient(90deg, var(--accent-2), var(--accent))}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0f1433; border:1px solid #2b3561; color:#cfe4ff; font-size:12px;}
    .kbd{font-weight:700; font-size:11px; background:#0b102b; border:1px solid #2a3560; color:#9fb4ff; padding:3px 6px; border-radius:6px;}
    footer{opacity:.85; padding:10px; font-size:12px; color:#95a5d6}
    a { color:#9ec5ff; text-decoration:none }
    a:hover{text-decoration:underline}
    .tiny{font-size:11px; color:#a8b6ff}
    .sep{opacity:.5; margin:0 6px}
    .metrics{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; font-size:12px; color:#cfe4ff; background:#0b102a; border:1px dashed #2b3561; border-radius:10px; padding:8px;}
    @media (max-width: 600px) {
      .manual-controls {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg);
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
        border-top: 1px solid #262c4a;
        z-index: 10;
      }
      .controls .manual-controls button { flex: 1; }
      .stimulus-area { max-width:100%; gap:8px; }
      .cell .dot { width: 80%; height: 80%; }
      .cell > div { max-width: 80%; max-height: 80%; }
    }
  </style>
  <meta name="description" content="Relational N-Back trainer with dynamic relation prompts on classic modality buttons. Position SameRow/SameCol/Closer/Farther, Sound Before/Same/After, Color Same/Opposite (true complement), Shape Fewer/Same/More sides." />
  <meta name="theme-color" content="#0f1220" />
  <script type="importmap">
  {
    "imports": {
      "seedrandom": "https://cdn.jsdelivr.net/npm/seedrandom@3.0.5/+esm"
    }
  }
  </script>
</head>
<body>
  <header>
    <h1>Relational N-Back — Dynamic Relation Buttons</h1>
    <div class="links">
      <span class="chip">Refs:
        <a class="chip" href="https://brainscale.net/app/dual-n-back/training" target="_blank" rel="noopener">brainscale.net</a>
        <a class="chip" href="https://4skinskywalker.github.io/Lite-Dual_N-back/Dichotic_Dual_N-back/" target="_blank" rel="noopener">4skinskywalker.github.io</a>
        <a class="chip" href="https://dev.to/michael_02910bc84e622d090/relational-n-back-4834" target="_blank" rel="noopener">dev.to</a>
      </span>
    </div>
  </header>
  <div class="container">
    <section class="card">
      <h2>Session Setup</h2>
      <div class="content grid">
        <div class="grid cols-2">
          <div>
            <label for="nLevel">N-back level</label>
            <input id="nLevel" type="number" min="1" max="9" value="1" />
          </div>
          <div>
            <label for="stimMs">Stimulus time (ms)</label>
            <input id="stimMs" type="number" min="300" step="50" value="1300" />
          </div>
          <div>
            <label for="isiMs">ISI / Gap (ms)</label>
            <input id="isiMs" type="number" min="0" step="50" value="300" />
          </div>
          <div>
            <label for="len">Sequence length</label>
            <input id="len" type="number" min="10" max="300" value="24" />
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Active modalities</label>
            <div class="row">
              <label class="switch" title="Position modality">
                <input id="mod-position" type="checkbox" checked />
                <span class="toggle"></span>
                Position
              </label>
            </div>
            <div class="row">
              <label class="switch" title="Sound modality">
                <input id="mod-sound" type="checkbox" checked />
                <span class="toggle"></span>
                Sound
              </label>
            </div>
            <div class="row">
              <label class="switch" title="Color modality">
                <input id="mod-color" type="checkbox" checked />
                <span class="toggle"></span>
                Color
              </label>
            </div>
            <div class="row">
              <label class="switch" title="Shape modality">
                <input id="mod-shape" type="checkbox" checked />
                <span class="toggle"></span>
                Shape
              </label>
            </div>
            <!-- COMPOSITE MODALITY: toggle -->
            <div class="row">
              <label class="switch" title="Composite modality: logical reduction over current & previous n trials of other active modalities">
                <input id="mod-composite" type="checkbox" />
                <span class="toggle"></span>
                Composite
              </label>
            </div>
            <!-- END COMPOSITE -->
          </div>
          <div>
            <label for="matchRatio">Prompt-true ratio (%)</label>
            <input id="matchRatio" type="number" min="10" max="90" value="33" />
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label for="lurePct">Lure trials (%)</label>
            <input id="lurePct" type="number" min="0" max="70" value="45" />
          </div>
          <div class="row">
            <label class="switch" title="Random jitter on stimulus and gap times">
              <input id="jitterOn" type="checkbox" checked />
              <span class="toggle"></span>
              Jitter timing
            </label>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="row">
            <label class="switch" title="Flip button prompt to currently requested relation; press only if true vs N-back.">
              <input id="dynamicLabels" type="checkbox" checked />
              <span class="toggle"></span>
              Dynamic prompts on buttons
            </label>
          </div>
          <div class="row">
            <label class="switch" title="Only accept responses during the stimulus window.">
              <input id="strictWindow" type="checkbox" />
              <span class="toggle"></span>
              Strict response window
            </label>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="row">
            <label class="switch" title="Auto adjust N using a staircase based on per-modality d′ and FA rate">
              <input id="adaptiveOn" type="checkbox" />
              <span class="toggle"></span>
              Adaptive N
            </label>
          </div>
          <div class="row">
            <label class="switch" title="Play procedural tones for feedback.">
              <input id="soundOn" type="checkbox" checked />
              <span class="toggle"></span>
              Sound on
            </label>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="row">
            <label class="switch" title="Announce stimuli via voice for accessibility (position, sound, color, shape).">
              <input id="voiceOn" type="checkbox" />
              <span class="toggle"></span>
              Voice cues
            </label>
          </div>
          <div class="row">
            <label class="switch" title="Use grayscale for colors (disable 'color' modality for full effect).">
              <input id="colorblind" type="checkbox" />
              <span class="toggle"></span>
              Colorblind mode
            </label>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="row">
            <label class="switch" title="Show visual feedback for correct answers.">
              <input id="showFeedback" type="checkbox" checked />
              <span class="toggle"></span>
              Show feedback
            </label>
          </div>
        </div>
        <div class="row">
          <span class="pill">Keys: 1..9 = modality buttons, N = No match, Space = Start/Stop</span>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn primary">Start</button>
          <button id="stopBtn" class="btn ghost" disabled>Stop</button>
          <button id="undoBtn" class="btn ghost" disabled>Undo</button>
          <button id="seedBtn" class="btn ghost" title="Regenerate sequence with new seed">Reseed</button>
          <button id="exportBtn" class="btn ghost">Export Log</button>
          <button id="resetBtn" class="btn warn">Reset Settings</button>
        </div>
        <div class="controls manual-controls">
          <button id="backBtn" class="btn ghost" title="Go to previous stimulus in manual mode (review only; no scoring).">Back</button>
          <button id="stepBtn" class="btn ghost" title="Advance one stimulus without timer; useful for testing.">Step</button>
        </div>
        <div class="grid">
          <div class="row">
            <div class="hint">Progress</div>
            <div class="hint" id="progressText">0 / 24</div>
          </div>
          <div class="bar"><div id="progressBar" class="fill"></div></div>
        </div>
      </div>
    </section>
    <section class="card stage">
      <div class="statusbar">
        <div class="badge">N=<span id="nLabel">1</span></div>
        <div class="badge">Score <span id="score">0</span></div>
        <div class="badge">Acc <span id="acc">100%</span></div>
        <div class="badge">Streak <span id="streak">0</span></div>
        <div class="badge">Trials <span id="trialCounter">0</span></div>
      </div>
      <div class="legend">
        Relational twist: Each modality’s button shows a prompt. Press it only if TRUE vs N-back.
        Position relations: Equal / SameRow / SameCol / Closer / Farther.
      </div>
      <div id="stimArea" class="stimulus-area" aria-live="polite" aria-atomic="true"></div>
      <div class="relation-bar" id="relationBar"></div>
      <div class="controls">
        <button id="passBtn" class="btn kbd" data-key="N">No match</button>
        <button id="hintBtn" class="btn">Peek</button>
        <button id="repeatBtn" class="btn">Repeat Stimulus</button>
        <button id="clearBtn" class="btn warn">Clear Prompts</button>
      </div>
      <div id="log" class="log"></div>
      <div id="metrics" class="metrics"></div>
      <div class="tiny" style="text-align:center; padding-bottom:8px">
        Grid index: 1..3 top row, 4..6 middle, 7..9 bottom. Sound A..E. Color uses true hue complement for “Opposite”.
        Shape relation is on sides: Fewer / Same / More. (Colorblind mode uses grayscale.)
      </div>
    </section>
  </div>
  <footer>
    Inspired by established dual n-back UX patterns such as brainscale.net and community adaptations like 4skinskywalker’s dichotic version. A relational variant has been discussed in community posts (e.g., dev.to). Improved with accessibility features.
  </footer>
  <div id="ariaAnnounce" aria-live="assertive" style="position:absolute; width:1px; height:1px; overflow:hidden; clip: rect(0,0,0,0);"></div>
  <div id="helpOverlay" style="display:none; position:fixed; top:20%; left:20%; right:20%; bottom:20%; background:var(--panel); border:1px solid #00000055; border-radius:14px; padding:20px; z-index:20; overflow:auto;">
    <h2>Help & Examples</h2>
    <p>Keyboard shortcuts: 1-4 for modality buttons, N for No match, Space to start/stop, ? to toggle this help.</p>
    <p>Example: For "Position" with prompt "SameRow", press the Position button if the current position is in the same row as the N-back position.</p>
    <p>Example: For "Color" with prompt "Opposite", press if the current color is the perceptual opposite of the N-back color.</p>
    <p>Example: For "Shape" with prompt "More", press if the current shape has more sides than the N-back one.</p>
    <!-- COMPOSITE help -->
    <p><b>Composite:</b> The button shows XOR/OR/AND/NAND. It evaluates the logical reduction of
      the “any-true” condition across the current and previous <em>n</em> trials of the other active modalities.
      Press only if that reduction is TRUE.</p>
    <!-- END COMPOSITE help -->
    <button onclick="this.parentNode.style.display='none'">Close</button>
  </div>
  <script type="module">
    import seedrandom from "seedrandom";
    // Seeded RNG
    let rng = seedrandom(String(Date.now()));
    const reseed = (seed) => { state.seed = seed ?? Date.now(); rng = seedrandom(String(state.seed)); };
    const R = (n)=>Math.floor(rng()*n);
    const pick = (arr)=>arr[R(arr.length)];
    const balancedPick = (arr, len) => {
      let res = [];
      while(res.length < len){
        res.push(...shuffle([...arr]));
      }
      return res.slice(0,len);
    };
    // DOM helpers
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const logEl = $("#log");
    const log = (msg)=>{ const t = new Date().toLocaleTimeString(); logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent; };
    const metricsEl = $("#metrics");
    const ariaAnnounce = $("#ariaAnnounce");
    // Procedural audio
    const audio = new (window.Au